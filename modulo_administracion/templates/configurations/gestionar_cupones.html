{% extends '../base.html' %}

{% block title %} Cupones {% endblock %}

{% block header %}  {% endblock %}


{% block content %}

<div class="container-fluid mt-4 coupon-management-container">
    <h1 class="mb-4 text-center">Gestionar Cupones</h1>

    <div class="row g-4">
        <div class="col-lg-5">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h2 class="mb-0">Crear Nuevo Cupón</h2>
                </div>
                <div class="card-body">
                    <form method="post" action="{% url 'gestionar_cupones' %}">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="codigo" class="form-label">Código:</label>
                            <input type="text" class="form-control" id="codigo" name="codigo" required>
                        </div>
                        <div class="mb-3">
                            <label for="descripcion" class="form-label">Descripción:</label>
                            <textarea class="form-control" id="descripcion" name="descripcion" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="tipo_descuento" class="form-label">Tipo de Descuento:</label>
                            <select class="form-select" id="tipo_descuento" name="tipo_descuento">
                                <option value="PORCENTAJE">Descuento Porcentual</option>
                                <option value="MONTO_FIJO">Descuento Monto Fijo</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="valor_descuento" class="form-label">Valor de Descuento:</label>
                            <input type="number" class="form-control" id="valor_descuento" name="valor_descuento" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="fecha_inicio" class="form-label">Fecha Inicio:</label>
                                <input type="datetime-local" class="form-control" id="fecha_inicio" name="fecha_inicio" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="fecha_vencimiento" class="form-label">Fecha Vencimiento:</label>
                                <input type="datetime-local" class="form-control" id="fecha_vencimiento" name="fecha_vencimiento" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="uso_maximo" class="form-label">Uso Máximo:</label>
                            <input type="number" class="form-control" id="uso_maximo" name="uso_maximo" required>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">Crear Cupón</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-lg-7">
            <div class="card h-100">
                <div class="card-header bg-secondary text-white">
                    <h2 class="mb-0">Cupones Existentes</h2>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>Código</th>
                                    <th>Tipo</th>
                                    <th>Valor</th>
                                    <th>Vigencia</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tbody">
                                
                              </tbody>
                              
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}


{% block scripts %}
<script>
    async function fetchData() {
    try {
        const response = await fetch("/administracion/gestionar-cupones/");
        const data = await response.json();

        console.log("Datos obtenidos:", data);

        const tbody = document.getElementById("tbody");
        tbody.innerHTML = ""; // Limpia el contenido previo

        for (const cupon of data) {
            const tr = document.createElement("tr");

            const idTd = document.createElement("td");
            idTd.idlist = cupon.id;
            idTd.textContent = cupon.id;
            tr.appendChild(idTd);

            const codigoTd = document.createElement("td");
            codigoTd.textContent = cupon.codigo;
            tr.appendChild(codigoTd);

            const tipoTd = document.createElement("td");
            tipoTd.textContent = cupon.tipo_descuento;
            tr.appendChild(tipoTd);

            const valorTd = document.createElement("td");
            valorTd.textContent = cupon.tipo_descuento === "MONTO_FIJO" ? `$${cupon.valor_descuento}` : `${cupon.valor_descuento}%`;
            tr.appendChild(valorTd);

            const fechasTd = document.createElement("td");
            fechasTd.textContent = `${cupon.fecha_inicio} - ${cupon.fecha_vencimiento}`;
            tr.appendChild(fechasTd);

            const accionesTd = document.createElement("td");
            const desactivarLink = document.createElement("a");
            desactivarLink.textContent = "Desactivar";
            desactivarLink.className = "btn btn-sm btn-danger me-2";
            const eliminarLink = document.createElement("a");
            eliminarLink.textContent = "Eliminar";
            eliminarLink.className = "btn btn-sm btn-danger ";
            

            // Asignar evento de click al botón
            desactivarLink.addEventListener("click", async (event) => {
                event.preventDefault(); // Evita la recarga de la página

                const flag = desactivarLink.classList.contains("btn-danger") ? 0 : 1;
                const url = `/administracion/desactivar-cupon/${cupon.id}/${flag}/`;

                try {
                    const response = await fetch(url, { method: 'GET' });
                    const data = await response.json();

                    // Cambiar el estado del botón según el resultado
                    if (desactivarLink.classList.contains("btn-danger")) {
                        
                        desactivarLink.classList.remove("btn-danger");
                        desactivarLink.classList.add("btn-success");
                        desactivarLink.innerHTML = "Activar";
                    } else {
                        desactivarLink.classList.remove("btn-success");
                        desactivarLink.classList.add("btn-danger");
                        desactivarLink.innerHTML = "Desactivar";
                    }

                    // Si lo deseas, puedes mostrar un mensaje en el frontend aquí
                    console.log(data.message); // O usar una notificación

                } catch (error) {
                    console.error("Error al actualizar el estado del cupón:", error);
                }
            });
            
            // Asignar evento de click al botón
            eliminarLink.addEventListener("click", async (event) => {
                event.preventDefault(); // Evita la recarga de la página
                
                const url = `/administracion/eliminar-cupon/${cupon.id}/`;
                
                try {
                    const response = await fetch(url, { method: 'GET' });
                    const data = await response.json();
                    
                    // Si lo deseas, puedes mostrar un mensaje en el frontend aquí
                    console.log(data.message); // O usar una notificación
                    
                    // Actualizar la lista de cupones
                    updateCouponList(data.cupones);
                } catch (error) {
                    console.error("Error al eliminar el cupón:", error);
                }
            });


            accionesTd.appendChild(desactivarLink);
            accionesTd.appendChild(eliminarLink);
            tr.appendChild(accionesTd);

            tbody.appendChild(tr);
        }
    } catch (error) {
        console.error("Error al obtener los datos:", error);
    }
}
fetchData();

document.getElementById("createCouponForm").addEventListener("submit", async function(event) {
    event.preventDefault(); // Evita la recarga de la página

    const formData = new FormData(this);

    try {
        // Asegúrate de que la URL sea la correcta
        const response = await fetch("/administracion/gestionar-cupones/", {
            method: "POST",
            body: formData
        });

        if (response.ok) {
            const data = await response.json(); // Si la respuesta es JSON

            console.log("Cupón creado exitosamente");

            // Limpiar formulario
            this.reset();

            // Actualizar la lista de cupones
            updateCouponList(data.cupones);
        } else {
            console.error("Error al crear el cupón, estado:", response.status);
        }
    } catch (error) {
        console.error("Error en la solicitud:", error);
    }
});

async function updateCouponList(cupones) {
    const tbody = document.getElementById("tbody");
    tbody.innerHTML = ""; // Limpiar contenido previo

    for (const cupon of cupones) {
        const tr = document.createElement("tr");

        const idTd = document.createElement("td");
        idTd.textContent = cupon.id;
        tr.appendChild(idTd);

        const codigoTd = document.createElement("td");
        codigoTd.textContent = cupon.codigo;
        tr.appendChild(codigoTd);

        const tipoTd = document.createElement("td");
        tipoTd.textContent = cupon.tipo_descuento;
        tr.appendChild(tipoTd);

        const valorTd = document.createElement("td");
        valorTd.textContent = cupon.valor_descuento;
        tr.appendChild(valorTd);

        const fechasTd = document.createElement("td");
        fechasTd.textContent = `${cupon.fecha_inicio} - ${cupon.fecha_vencimiento}`;
        tr.appendChild(fechasTd);

        const accionesTd = document.createElement("td");
        const desactivarLink = document.createElement("a");
        desactivarLink.textContent = "Desactivar";
        desactivarLink.className = "btn btn-sm btn-danger";
        const eliminarLink = document.createElement("a");
        eliminarLink.textContent = "Eliminar";
        eliminarLink.className = "btn btn-sm btn-danger";

        // Asignar evento de click al botón
        desactivarLink.addEventListener("click", async (event) => {
            event.preventDefault(); // Evita la recarga de la página

            const flag = desactivarLink.classList.contains("btn-danger") ? 0 : 1;
            const url = `/administracion/desactivar-cupon/${cupon.id}/${flag}/`;

            try {
                const response = await fetch(url, { method: 'GET' });
                const data = await response.json();

                // Cambiar el estado del botón según el resultado
                if (desactivarLink.classList.contains("btn-danger")) {
                    desactivarLink.classList.remove("btn-danger");
                    desactivarLink.classList.add("btn-success");
                    desactivarLink.textContent = "Activar";
                } else {
                    desactivarLink.classList.remove("btn-success");
                    desactivarLink.classList.add("btn-danger");
                    desactivarLink.textContent = "Desactivar";
                }
            } catch (error) {
                console.error("Error al cambiar estado del cupón:", error);
            }
        });
        // Asignar evento de click al botón
        eliminarLink.addEventListener("click", async (event) => {
            event.preventDefault(); // Evita la recarga de la página
            
            const url = `/administracion/eliminar-cupon/${cupon.id}/`;
            
            try {
                const response = await fetch(url, { method: 'GET' });
                const data = await response.json();
                
                // Si lo deseas, puedes mostrar un mensaje en el frontend aquí
                console.log(data.message); // O usar una notificación
                
                // Actualizar la lista de cupones
                updateCouponList(data.cupones);
            } catch (error) {
                console.error("Error al eliminar el cupón:", error);
            }
        });

        accionesTd.appendChild(desactivarLink);
        accionesTd.appendChild(eliminarLink);
        tr.appendChild(accionesTd);

        tbody.appendChild(tr);
    }
}
</script>
{% endblock %}