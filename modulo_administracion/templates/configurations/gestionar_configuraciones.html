{% extends '../base.html' %}

{% block title %} Configuraciones {% endblock %}

{% block header %}  {% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <h1 class="mb-4 text-center">Gestionar Configuraciones</h1>

    <div class="row g-4">
        <!-- Formulario para crear o editar configuración -->
        <div class="col-lg-5">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h2 class="mb-0" id="form-title">Crear Nueva Configuración</h2>
                </div>
                <div class="card-body">
                    <form id="configForm" method="post" enctype="multipart/form-data" action="{% url 'gestionar_configuraciones' %}">
                        {% csrf_token %}
                        <input type="hidden" id="configuracionId" name="configuracionId">
                        <div class="mb-3">
                            <label for="name" class="form-label">Nombre:</label>
                            <input type="text" class="form-control" id="name" name="name">
                        </div>
                        <div class="mb-3">
                            <label for="address" class="form-label">Dirección:</label>
                            <input type="text" class="form-control" id="address" name="address">
                        </div>
                        <div class="mb-3">
                            <label for="color_pallette" class="form-label">Paleta de Colores:</label>
                            <input type="text" class="form-control" id="color_pallette" name="color_pallette">
                        </div>
                        <div class="mb-3">
                            <label for="pathLogo" class="form-label">Logo:</label>
                            <input type="file" class="form-control" id="pathLogo" name="pathLogo">
                        </div>
                        <div class="mb-3">
                            <label for="path_slogan" class="form-label">Slogan:</label>
                            <input type="file" class="form-control" id="path_slogan" name="path_slogan">
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="isPointActive" name="isPointActive">
                            <label for="isPointActive" class="form-check-label">¿Programa de lealtad activo?</label>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">Guardar Configuración</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Tabla de configuraciones existentes -->
        <div class="col-lg-7">
            <div class="card h-100">
                <div class="card-header bg-secondary text-white">
                    <h2 class="mb-0">Configuraciones Existentes</h2>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>Nombre</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="configTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block scripts %}
    <script>
        async function fetchConfigurations() {
            try {
                const response = await fetch("{% url 'gestionar_configuraciones' %}");
                const configuraciones = await response.json();

                const tbody = document.getElementById("configTableBody");
                tbody.innerHTML = ""; // Limpiar tabla

                configuraciones.forEach(config => {
                    const tr = document.createElement("tr");

                    const idTd = document.createElement("td");
                    idTd.textContent = config.id;
                    tr.appendChild(idTd);

                    const nameTd = document.createElement("td");
                    nameTd.textContent = config.name || "Sin Nombre";
                    tr.appendChild(nameTd);

                    const actionsTd = document.createElement("td");
                    const editBtn = document.createElement("button");
                    editBtn.className = "btn btn-sm btn-warning me-2";
                    editBtn.textContent = "Editar";
                    editBtn.addEventListener("click", () => loadConfigForEdit(config.id));
                    actionsTd.appendChild(editBtn);

                    const deleteBtn = document.createElement("button");
                    deleteBtn.className = "btn btn-sm btn-danger";
                    deleteBtn.textContent = "Eliminar";
                    deleteBtn.addEventListener("click", () => deleteConfiguration(config.id));
                    actionsTd.appendChild(deleteBtn);

                    tr.appendChild(actionsTd);
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error("Error al obtener configuraciones:", error);
            }
        }

        async function loadConfigForEdit(id) {
            try {
                const response = await fetch(`/editar-configuracion/${id}/`);
                const config = await response.json();

                document.getElementById("form-title").textContent = "Editar Configuración";
                document.getElementById("configuracionId").value = config.id;
                document.getElementById("name").value = config.name;
                document.getElementById("address").value = config.address;
                document.getElementById("color_pallette").value = config.color_pallette;
                document.getElementById("isPointActive").checked = config.isPointActive;
            } catch (error) {
                console.error("Error al cargar configuración:", error);
            }
        }

        async function deleteConfiguration(id) {
            if (!confirm("¿Estás seguro de que deseas eliminar esta configuración?")) return;

            try {
                await fetch(`/eliminar-configuracion/${id}/`);
                alert("Configuración eliminada exitosamente");
                fetchConfigurations();
            } catch (error) {
                console.error("Error al eliminar configuración:", error);
            }
        }

        document.addEventListener("DOMContentLoaded", fetchConfigurations);

    </script>
{% endblock %}